
# Mastra と Vercel AI SDK の互換性問題に関する調査レポート

**日付:** 2025-08-01

## 1. 問題の概要

本プロジェクトにおいて、最新のGoogle AIモデル（例: `gemini-1.5-flash`）を利用しようとしたところ、`@ai-sdk/google` v2.0.0 と `Mastra` (`@mastra/core`) の間で互換性の問題が発生し、アプリケーションが正常に動作しない事象が確認された。

具体的には、`@ai-sdk/google` のバージョンを `^1.2.22` にダウングレードすると動作するが、その場合、古いAIモデルしか利用できないという制約が発生する。

## 2. 根本原因

調査の結果、根本原因は `@mastra/core` と `@ai-sdk/google` v2.0.0 の**依存関係の衝突**にあることが判明した。

- **`@ai-sdk/google` v2.0.0** は、`@ai-sdk/provider` **v2.0.0** に依存している。
- **`@mastra/core` v0.12.0** は、`@ai-sdk/provider` **v0.0.8** という非常に古いバージョンに依存している。

`npm` は、一つのプロジェクト内で同じパッケージの異なるメジャーバージョンを共存させることができないため、この依存関係の著しいバージョンの違いが競合を引き起こし、エラーの原因となっていた。

## 3. 証拠: `@mastra/core` の依存関係

`@mastra/core` の `package.json` を確認したところ、以下の依存関係が定義されていた。

```json
"dependencies": {
  "@ai-sdk/provider": "^0.0.8",
  "@paralleldrive/cuid2": "^2.2.2",
  "valibot": "^0.30.0",
  "zod": "^3.22.4",
  "zod-to-json-schema": "^3.22.3"
}
```

`@ai-sdk/provider: ^0.0.8` という記述が、互換性の問題の直接的な証拠である。

## 4. Qiita記事の事例分析

提示されたQiita記事の事例では、`Mastra` と `Gemini` を連携させているが、これは **Vercel AI SDK (`@ai-sdk/google`) を利用していない**ため可能であった。

この記事のケースでは、`Mastra` フレームワークが提供する独自の組み込み機能を使って `Gemini` APIと直接通信している。そのため、Vercel AI SDKとの依存関係の衝突が発生していない。

## 5. 結論と今後の選択肢

**結論:**
`Mastra` と Vercel AI SDK (`@ai-sdk/google`, `@ai-sdk/openai` 等) は、`Mastra` の依存関係が古すぎるため、**現時点では併用不可能**である。

**今後の選択肢:**

1.  **`Mastra` の流儀に従う:**
    - プロジェクトから `@ai-sdk/google` をアンインストールする。
    - `Mastra` のドキュメントに従い、`Mastra` 独自の機能でAIモデルとの連携を実装する。
    - **懸念点:** `Mastra` が最新モデルに追随している保証がなく、将来性が不透明。

2.  **`Mastra` から脱却する（推奨）:**
    - プロジェクトから `@mastra/core` をアンインストールする。
    - Vercel AI SDK (`@ai-sdk/google` v2.0.0) を直接利用して、エージェントのロジックを再構築する。
    - **利点:** 最新のAIモデルや機能を自由に利用でき、柔軟性と将来性が高い。

